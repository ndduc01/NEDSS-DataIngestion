# 
# 	Script to deploy applications
# 

apiVersion: v1
kind: Namespace
metadata:
  name: k8-di-apps

---

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    service: jwtgenerator
  name: jwtgenerator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jwtgenerator
  template:
    metadata:
      labels:
        app: jwtgenerator
    spec:
      containers:
      - name: jwtgenerator
        image: raddanki64/eqartifacts:jwtgenerator
        imagePullPolicy: Always
        ports:
          - containerPort: 8000
        env:
          - name: HASHIVAULT_ENABLED
            value: "false"
          - name: JWT_SECRETFORALGORITHM
            valueFrom:
              configMapKeyRef:
                name: jwtgenerator-config
                key: jwt_secret_for_algorithm
          - name: JWT_CLAIMNAME
            valueFrom:
              configMapKeyRef:
                name: jwtgenerator-config
                key: jwt_claim_name
          - name: JWT_CLAIMEMAIL
            valueFrom:
              configMapKeyRef:
                name: jwtgenerator-config
                key: jwt_claim_email
          - name: JWT_CLAIMSUBJECT
            valueFrom:
              configMapKeyRef:
                name: jwtgenerator-config
                key: jwt_claim_subject
          - name: JWT_SEED
            valueFrom:
              configMapKeyRef:
                name: jwtgenerator-config
                key: jwt_seed

---

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    service: phinadapter
  name: phinadapter
spec:
  replicas: 1
  selector:
    matchLabels:
      app: phinadapter
  template:
    metadata:
      labels:
        app: phinadapter
    spec:
      containers:
      - name: phinadapter
        imagePullPolicy: IfNotPresent
        image: raddanki64/eqartifacts:phinadapter
        ports:
          - containerPort: 8090
        env:
          - name: HASHIVAULT_ENABLED
            value: "false"
          - name: SPRING_DATASOURCE_URL
            valueFrom:
              configMapKeyRef:
                name: phinadapter-config
                key: odsedb_url
          - name: SPRING_DATASOURCE_USERNAME
            valueFrom:
              configMapKeyRef:
                name: phinadapter-config
                key: odsedb_username
          - name: SPRING_DATASOURCE_PASSWORD
            valueFrom:
              configMapKeyRef:
                name: phinadapter-config
                key: odsedb_password
          - name: JWT_ENABLED
            valueFrom:
              configMapKeyRef:
                name: phinadapter-config
                key: jwt_enabled
          - name: JWT_ENDPOINT
            valueFrom:
              configMapKeyRef:
                name: phinadapter-config
                key: jwt_endpoint
          - name: JWT_SEED
            valueFrom:
              configMapKeyRef:
                name: phinadapter-config
                key: jwt_seed

---

apiVersion: v1
kind: Service
metadata:
  name: jwtgenerator
spec:
  type: LoadBalancer
  selector:
    app: jwtgenerator
  ports:
    - port: 8000
      targetPort: 8000

---

apiVersion: v1
kind: Service
metadata:
  name: phinadapter
spec:
  type: LoadBalancer
  selector:
    app: phinadapter
  ports:
    - port: 8090
      targetPort: 8090

